<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>A simple map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
<link href='/static/map.css' rel='stylesheet' />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.min.js"></script>


<script type="text/javascript" src="/static/jsonTable.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { width:800px; height:400px }
</style>
</head>
<body onload="onceonload()">

<nav id='menu-ui' class='menu-ui'></nav>
<div id='map' height='400px' width='300px'></div>
<hr/>
Time <input id='time' size=40 value=''></input> 
<a onclick="incrTime(-15);return false;" href="#">-15 mins</a> 
<a href="#" onclick="incrTime(15);return false;">+15 mins</a>
<br/>
Location (Lat/Long) <input id='lat' size=5 value='40.7'></input> 
<input id='long' size=5 value='-74.00'></input> 
<button id='butgetloc' onclick="getLocationWG()">Get Location</button> 
<button id='butcenter' onclick="setMapCenter()">Set Map Center</button>
<button id='butqueryloc' onclick="queryLocation()">Query Location</button>
<hr/>
      <div id="divqueryoutput"></div>
      
    <table id="jqGridTable"></table>
    <div id="jqGridPager"></div>
    <br/>
    <center>
    <table id="dataTable" style="color: red;">
        </table>
    </center>
<script>
var markerl = Array();

L.mapbox.accessToken = 'pk.eyJ1IjoiZ3JvdmVzIiwiYSI6InJVYlgxMDgifQ.ga1zqHlEQiF5ncOmZRYIhA';
//var map = L.mapbox.map('map', 'groves.vgmvlsor')
var map = L.mapbox.map('map','examples.map-i86nkdio')//'groves.ko5epoo1')
    .setView([40.7, -74.00], 12);
    
var layers = document.getElementById('menu-ui');

addLayer(L.mapbox.tileLayer('groves.vgmvlsor'), 'USGS Roads', 1);
addLayer(L.mapbox.tileLayer('groves.0c2z9f6r'), 'Dropoffs at 12a', 2);
addLayer(L.mapbox.tileLayer('groves.89rafw29'), 'Dropoffs at 12p', 3);
//addLayer(L.mapbox.tileLayer('examples.map-i86nkdio'), 'USGS Roads', 1);
//addLayer(L.mapbox.tileLayer('examples.map-20v6611k'), 'Dropoffs at 12a', 2);
//addLayer(L.mapbox.tileLayer('examples.map-2k9d7u0c'), 'Dropoffs at 12p', 3);

function addLayer(layer, name, zIndex) {
    layer
        .setZIndex(zIndex)
        .addTo(map);

    // Create a simple layer switcher that
    // toggles layers on and off.
    var link = document.createElement('a');
        link.href = '#';
        link.className = 'active';
        link.innerHTML = name;

    link.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
            this.className = '';
        } else {
            map.addLayer(layer);
            this.className = 'active';
        }
    };

    layers.appendChild(link);
}
</script>

<script>
var iboxlong = document.getElementById("long");
var iboxlat = document.getElementById("lat");
var iboxtime = document.getElementById("time");
function getLocationWG() {
    if (navigator.geolocation) {
        if (window.location.protocol == 'file:') {
            showPositionWG({'coords':{'latitude':40.6,'longitude':-74.02}});
        }
        else {
        navigator.geolocation.getCurrentPosition(showPositionWG);
        }
    } else { 
        iboxlong.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function showPositionWG(position) {
    iboxlat.value = Math.round(position.coords.latitude * 10000) / 10000;
    iboxlong.value = Math.round( position.coords.longitude * 10000) / 10000;
    
    //iboxlat.value = position.coords.latitude;
    //iboxlong.value = position.coords.longitude;
}

function queryLocation() { // query busyness and add info to map
    outputdiv = document.getElementById('divqueryoutput');
    //outputdiv.innerHTML = "Removing existing markers and querying...";
    
    //remove all existing markers
    console.log("removing all markers");
    while (markerl.length > 0) {
        newmarker = markerl.pop();
        map.removeLayer(newmarker);
    }
    console.log("all markers removed");
    
    latlng = map.getCenter();
    newmarker = L.marker([
        latlng.lat, latlng.lng
    ], {
        icon: L.divIcon({
            // Specify a class name we can refer to in CSS.
            className: 'count-icon',
            // Define what HTML goes in each marker.
            html: 'X',
            // Set a markers width and height.
            iconSize: [38, 38]
        })
    })
    markerl.push(newmarker);
    newmarker.addTo(map);
    
    //outputdiv.innerHTML = "added thing to map";
    
    ttime = new Date(document.getElementById('time').value);
    $.ajax({
  dataType: "json",
  url: "/suggestapi",
  data: {'lat':latlng.lat,'lng':latlng.lng,'time':Math.round(ttime.getTime()/1000)},
  success: function( json ) {
    console.log("received json!" + JSON.stringify(json));
    outputdiv = document.getElementById('divqueryoutput');
    //outputdiv.innerHTML = JSON.stringify(json);

    newlocationl = json.nearestplaces;
    
    //ADD JSON TABLE HANDLING HERE
    var options = {
                source: json.nearestplaces,
                rowClass: "classy",
                callback: function(){
                }
            };
            
            ///////////////////////////////
            // Test on a pre-existing table
	$("#dataTable").jsonTable({
		        head : ['Rank','Distance (mi)','Lat','Long','Expected Wait (mins)','DO:PU ratio','Intersection'],
		        json : ['rank','dst_mi','lat_txt','lon_txt','pu_wait','do_pu_ratio','intersection_name']
	        });
	$("#dataTable").jsonTableUpdate(options);
    
    /*
    $("#jqGridTable").jqGrid({
                datatype: "json",
                   jsonReader : {
      root:"invdata",
      page: "currpage",
      total: "totalpages",
      records: "totalrecords",
      repeatitems: false,
      id: "0"
   },
                data:{
   "page":"1",
   "total":2,
   "records":"13", 
   "rows": newlocationl},
                height: 250,
                width: 780,
                colModel: [
                    { label: 'Lat', name: 'id', width: 75, key:true },
                    { label: 'Lng', name: 'invdate', width: 90 }
                ],
                
                viewrecords: true, // show the current page, data rang and total records on the toolbar
                caption: "Nearby Places",
            });
    */
    i = 1;
    while (newlocationl.length > 0) {
        newlocation = newlocationl.shift();
        markerlatlng = [newlocation.lat, newlocation.lon];
        console.log("adding marker at"+markerlatlng);
        newmarker = L.marker(markerlatlng, {
        icon: L.divIcon({
            // Specify a class name we can refer to in CSS.
            className: 'count-icon',
            // Define what HTML goes in each marker.
            html: i,
            // Set a markers width and height.
            iconSize: [38, 38]
        })
       })
        markerl.push(newmarker);
        newmarker.addTo(map);
        var line = Array();
        line.push(latlng);
        line.push(markerlatlng);
        var polyline_options = {
        color: '#000',
        opacity: 0.5,         // Stroke opacity
        weight: 5         // Stroke weight
        };

        var polyline = L.polyline(line, polyline_options).addTo(map);
        markerl.push(polyline);
        i=i+1;
    }
    console.log("finished parsing nearby places");
    

  }
});


} //end of queryLocation

function setMapCenter() {
    map.setView([iboxlat.value, iboxlong.value], 15);
}

function onceonload() { // What to do on page load:

map.addEventListener('moveend',function (v) {
latlng = map.getCenter();
showPositionWG({'coords':{'latitude':latlng.lat, 'longitude':latlng.lng}});
});

var dateobj = new Date();
document.getElementById('time').value = ''+dateobj;


}//end of onceonload

</script>

<script>

function incrTime(incr) {

    ttime = new Date(document.getElementById('time').value);
    newtime = new Date(ttime.getTime()+incr*1000*60);
    tbut = document.getElementById('time');
    tbut.value = ''+newtime;
}


// Set button behaviors

//$('#')[0].onclick=wgprev;
//$('.changeimagen')[0].onclick=wgnext;
</script>


</body>
</html>
